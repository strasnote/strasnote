!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(f){"use strict";function o(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function p(e){return e.state.search||(e.state.search=new o)}function t(e){return"string"==typeof e&&e==e.toLowerCase()}function d(e,o,r){return e.getSearchCursor(o,r,{caseFold:t(o),multiline:!0})}function m(e,o,r,n,t){e.openDialog?e.openDialog(o,t,{value:n,selectValueOnOpen:!0,bottom:e.options.search.bottom}):t(prompt(r,n))}function y(e){return e.replace(/\\([nrt\\])/g,function(e,o){return"n"==o?"\n":"r"==o?"\r":"t"==o?"\t":"\\"==o?"\\":e})}function a(e){var o=e.match(/^\/(.*)\/([a-z]*)$/);if(o)try{e=new RegExp(o[1],-1==o[2].indexOf("i")?"":"i")}catch(e){}else e=y(e);return e=("string"==typeof e?""==e:e.test(""))?/x^/:e}function h(e,o,r){var n;o.queryText=r,o.query=a(r),e.removeOverlay(o.overlay,t(o.query)),o.overlay=(n=o.query,r=t(o.query),"string"==typeof n?n=new RegExp(n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),r?"gi":"g"):n.global||(n=new RegExp(n.source,n.ignoreCase?"gi":"g")),{token:function(e){n.lastIndex=e.pos;var o=n.exec(e.string);if(o&&o.index==e.pos)return e.pos+=o[0].length||1,"searching";o?e.pos=o.index:e.skipToEnd()}}),e.addOverlay(o.overlay),e.showMatchesOnScrollbar&&(o.annotate&&(o.annotate.clear(),o.annotate=null),o.annotate=e.showMatchesOnScrollbar(o.query,t(o.query)))}function r(t,o,e,r){var n=p(t);if(n.query)return g(t,o);var a,i,s,c,l,u=t.getSelection()||n.lastQuery;u instanceof RegExp&&"x^"==u.source&&(u=null),e&&t.openDialog?(a=null,i=function(e,o){f.e_stop(o),e&&(e!=n.queryText&&(h(t,n,e),n.posFrom=n.posTo=t.getCursor()),a&&(a.style.opacity=1),g(t,o.shiftKey,function(e,o){var r;o.line<3&&document.querySelector&&(r=t.display.wrapper.querySelector(".CodeMirror-dialog"))&&r.getBoundingClientRect().bottom-4>t.cursorCoords(o,"window").top&&((a=r).style.opacity=.4)}))},e=C(s=t),c=u,l=function(e,o){var r=f.keyName(e),n=t.getOption("extraKeys"),n=n&&n[r]||f.keyMap[t.getOption("keyMap")][r];"findNext"==n||"findPrev"==n||"findPersistentNext"==n||"findPersistentPrev"==n?(f.e_stop(e),h(t,p(t),o),t.execCommand(n)):"find"!=n&&"findPersistent"!=n||(f.e_stop(e),i(o,e))},s.openDialog(e,i,{value:c,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){v(s)},onKeyDown:l,bottom:s.options.search.bottom}),r&&u&&(h(t,n,u),g(t,o))):m(t,C(t),"Search for:",u,function(e){e&&!n.query&&t.operation(function(){h(t,n,e),n.posFrom=n.posTo=t.getCursor(),g(t,o)})})}function g(r,n,t){r.operation(function(){var e=p(r),o=d(r,e.query,n?e.posFrom:e.posTo);(o.find(n)||(o=d(r,e.query,n?f.Pos(r.lastLine()):f.Pos(r.firstLine(),0))).find(n))&&(r.setSelection(o.from(),o.to()),r.scrollIntoView({from:o.from(),to:o.to()},20),e.posFrom=o.from(),e.posTo=o.to(),t&&t(o.from(),o.to()))})}function v(o){o.operation(function(){var e=p(o);e.lastQuery=e.query,e.query&&(e.query=e.queryText=null,o.removeOverlay(e.overlay),e.annotate&&(e.annotate.clear(),e.annotate=null))})}function x(e,o){var r,n=e?document.createElement(e):document.createDocumentFragment();for(r in o)n[r]=o[r];for(var t=2;t<arguments.length;t++){var a=arguments[t];n.appendChild("string"==typeof a?document.createTextNode(a):a)}return n}function C(e){return x("",null,x("span",{className:"CodeMirror-search-label"},e.phrase("Search:"))," ",x("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})," ",x("span",{style:"color: #888",className:"CodeMirror-search-hint"},e.phrase("(Use /re/ syntax for regexp search)")))}function q(o,n,t){o.operation(function(){for(var r,e=d(o,n);e.findNext();)"string"!=typeof n?(r=o.getRange(e.from(),e.to()).match(n),e.replace(t.replace(/\$(\d)/g,function(e,o){return r[o]}))):e.replace(t)})}function n(u,e){var o,r,n;u.getOption("readOnly")||(o=u.getSelection()||p(u).lastQuery,n=x("",null,x("span",{className:"CodeMirror-search-label"},r=e?u.phrase("Replace all:"):u.phrase("Replace:")),(n=u,x("",null," ",x("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})," ",x("span",{style:"color: #888",className:"CodeMirror-search-hint"},n.phrase("(Use /re/ syntax for regexp search)"))))),m(u,n,r,o,function(l){l&&(l=a(l),m(u,x("",null,x("span",{className:"CodeMirror-search-label"},u.phrase("With:"))," ",x("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})),u.phrase("Replace with:"),"",function(a){var i,s,c;a=y(a),e?q(u,l,a):(v(u),i=d(u,l,u.getCursor("from")),c=function(r){i.replace("string"==typeof l?a:a.replace(/\$(\d)/g,function(e,o){return r[o]})),s()},(s=function(){var e,o,r,n,t=i.from();!(e=i.findNext())&&(i=d(u,l),!(e=i.findNext())||t&&i.from().line==t.line&&i.from().ch==t.ch)||(u.setSelection(i.from(),i.to()),u.scrollIntoView({from:i.from(),to:i.to()}),n=x("",null,x("span",{className:"CodeMirror-search-label"},(n=t=u).phrase("Replace?"))," ",x("button",{},n.phrase("Yes"))," ",x("button",{},n.phrase("No"))," ",x("button",{},n.phrase("All"))," ",x("button",{},n.phrase("Stop"))),o=u.phrase("Replace?"),r=[function(){c(e)},s,function(){q(u,l,a)}],t.openConfirm?t.openConfirm(n,r):confirm(o)&&r[0]())})())}))}))}f.defineOption("search",{bottom:!1}),f.commands.find=function(e){v(e),r(e)},f.commands.findPersistent=function(e){v(e),r(e,!1,!0)},f.commands.findPersistentNext=function(e){r(e,!1,!0,!0)},f.commands.findPersistentPrev=function(e){r(e,!0,!0,!0)},f.commands.findNext=r,f.commands.findPrev=function(e){r(e,!0)},f.commands.clearSearch=v,f.commands.replace=n,f.commands.replaceAll=function(e){n(e,!0)}});